{"componentChunkName":"component---src-templates-content-template-js","path":"/en/part8/login_and_updating_the_cache","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>The frontend of our application shows the phone directory just fine with the updated server. However if we want to add new persons, we have to add login functionality to the frontend. </p>\n<h3>User log in</h3>\n<!-- Lisätään sovelluksen tilaan muuttuja _token_, joka tallettaa tokenin siinä vaiheessa kun käyttäjä on kirjautunut. Jos _token_ ei ole määritelty, näytetään kirjautumisesta huolehtiva komponentti <i>LoginForm</i>, joka saa parametriksi virheenkäsittelijän sekä funktion _setToken_: -->\n<p>Let's add variable <em>token</em> to the application's state. It will contain user's token when a is logged in. If <em>token</em> is undefined, we render the <i>LoginForm</i>-component responsible for user login. The component receives an error handler and the <em>setToken</em>-function as parameters:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>token<span class=\"token punctuation\">,</span> setToken<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>Notify errorMessage<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>errorMessage<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>h2<span class=\"token operator\">></span>Login<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h2<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>LoginForm\n          setToken<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>setToken<span class=\"token punctuation\">}</span>\n          setError<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>notify<span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<!-- Määritellään kirjautumisen suorittava mutaatio -->\n<p>Next we define a mutation for logging in</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">LOGIN</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  mutation login($username: String!, $password: String!) {\n    login(username: $username, password: $password)  {\n      value\n    }\n  }\n</span><span class=\"token template-punctuation string\">`</span></span></code></pre></div>\n<!-- Kirjautumisesta huolehtiva komponentti _LoginForm_ toimii melko samalla tavalla kuin aiemmat mutaatioista huolehtivat komponentit. Mielenkiintoiset rivit on korostettu koodissa: -->\n<p>The <em>LoginForm</em>-component works pretty much just like all other components doing mutations we have previously created.\nInteresting lines in the code have been highlighted:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useState<span class=\"token punctuation\">,</span> useEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useMutation <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@apollo/client'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">LOGIN</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../queries'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">LoginForm</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> setError<span class=\"token punctuation\">,</span> setToken <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>username<span class=\"token punctuation\">,</span> setUsername<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>password<span class=\"token punctuation\">,</span> setPassword<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span> login<span class=\"token punctuation\">,</span> result <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LOGIN</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span></span>    <span class=\"token function-variable function\">onError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setError</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>graphQLErrors<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> result<span class=\"token punctuation\">.</span>data <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>login<span class=\"token punctuation\">.</span>value</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">setToken</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'phonenumbers-user-token'</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// eslint-disable-line</span></span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">submit</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    event<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> variables<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> username<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>form onSubmit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>submit<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n          username <span class=\"token operator\">&lt;</span>input\n            value<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>username<span class=\"token punctuation\">}</span>\n            onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> target <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setUsername</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n          password <span class=\"token operator\">&lt;</span>input\n            type<span class=\"token operator\">=</span><span class=\"token string\">'password'</span>\n            value<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>password<span class=\"token punctuation\">}</span>\n            onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> target <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setPassword</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>button type<span class=\"token operator\">=</span><span class=\"token string\">'submit'</span><span class=\"token operator\">></span>login<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>form<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> LoginForm</code></pre></div>\n<!-- Käytössä on jälleen efektihookki, jonka avulla asetetaan tokenin arvo komponentin _App_ tilaan sekä local storageen siinä vaiheessa kun palvelin on vastannut mutaatioon. Efektihookki on tarpeen, jotta sovellus ei joutuisi ikuiseen renderöintilooppiin. -->\n<p>We are using an effect hook again. Here it's used to save the token's value to the state of the <em>App</em> component and the local storage after the server has responded to the mutation.\nUse of the effect hook is necessary to avoid an endless rendering loop.</p>\n<p>Let's also add a button which enables a logged in user to log out. The button's onClick handler sets the <em>token</em> state to null, removes the token from local storage and resets the cache of the Apollo client. The last step is <a href=\"https://www.apollographql.com/docs/react/networking/authentication/#reset-store-on-logout\">important</a>, because some queries might have fetched data to cache, which only logged in users should have access to. </p>\n<!-- Välimuistin nollaaminen tapahtuu Apollon _client_-objektin metodilla [resetStore](https://www.apollographql.com/docs/react/v3.0-beta/api/core/ApolloClient/#ApolloClient.resetStore), clientiin taas päästään käsiksi hookilla -->\n<!-- [useApolloClient](https://www.apollographql.com/docs/react/api/react-hooks/#useapolloclient): -->\n<p>We can reset the cache using the <a href=\"https://www.apollographql.com/docs/react/v3.0-beta/api/core/ApolloClient/#ApolloClient.resetStore\">resetStore</a> method of an Apollo <em>client</em> object.\nThe client can be accessed with the <a href=\"https://www.apollographql.com/docs/react/api/react-hooks/#useapolloclient\">useApolloClient</a> hook:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>token<span class=\"token punctuation\">,</span> setToken<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>errorMessage<span class=\"token punctuation\">,</span> setErrorMessage<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ALL_PERSONS</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token function\">useApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>loading<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>loading<span class=\"token operator\">...</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">logout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token function\">setToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    client<span class=\"token punctuation\">.</span><span class=\"token function\">resetStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The current code of the application can be found on <a href=\"https://github.com/fullstack-hy2020/graphql-phonebook-frontend/tree/part8-6\">Github</a>, branch <i>part8-6</i>.</p>\n<h3>Adding a token to a header</h3>\n<p>After the backend changes, creating new persons requires that a valid user token is sent with the request. In order to send the token, we have to change the way we define the <em>ApolloClient</em>-object in <i>index.js</i> a little. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> setContext <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'apollo-link-context'</span></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> authLink <span class=\"token operator\">=</span> <span class=\"token function\">setContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'phonenumbers-user-token'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token operator\">...</span>headers<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      authorization<span class=\"token operator\">:</span> token <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> httpLink <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> uri<span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:4000'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  cache<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InMemoryCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">  link<span class=\"token operator\">:</span> authLink<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>httpLink<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<!-- _client_-olion muodostamisen yhteydessä oleva toinen parametri _link_ määrittelee, miten apollo on yhteydessä palvelimeen. Nyt normaalia [httpLink](https://www.apollographql.com/docs/link/links/http.htm)-yhteyttä muokataan siten, että, että pyyntöjen mukaan [asetetaan headerille](https://www.apollographql.com/docs/react/networking/authentication/#header) <i>authorization</i> arvoksi localStoragessa mahdollisesti oleva token. -->\n<p>The link parameter given to the <em>client</em>-object defines how apollo connects to the server. Here the normal <a href=\"https://www.apollographql.com/docs/link/links/http.htm\">httpLink</a> connection is modified so that the request's <i>authorization</i> <a href=\"https://www.apollographql.com/docs/react/networking/authentication/#header\">header</a> contains the token if one has been saved to the localStorage. </p>\n<!-- Asennetaan vielä muutoksen tarvitsema kirjasto -->\n<p>We also need to install the library required by this modification</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> apollo-link-context</code></pre></div>\n<p>Creating new persons and changing numbers works again. There is however one remaining problem. If we try to add a person without a phone number, it is not possible. </p>\n<picture><img src=\"/static/e35da7a06eae17e19eb71dacbb437782/5a190/25e.png\" srcset=\"/static/e35da7a06eae17e19eb71dacbb437782/772e8/25e.png 200w,\n/static/e35da7a06eae17e19eb71dacbb437782/e17e5/25e.png 400w,\n/static/e35da7a06eae17e19eb71dacbb437782/5a190/25e.png 800w,\n/static/e35da7a06eae17e19eb71dacbb437782/c1b63/25e.png 1200w,\n/static/e35da7a06eae17e19eb71dacbb437782/86a1e/25e.png 1296w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Validation fails, because frontend sends an empty string as the value of <em>phone</em>.</p>\n<p>Let's change the function creating new persons so that it sets <em>phone</em> to null if user has not given a value. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">PersonForm</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> setError <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">submit</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    event<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">createPerson</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      variables<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> \n<span class=\"gatsby-highlight-code-line\">        name<span class=\"token punctuation\">,</span> street<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        phone<span class=\"token operator\">:</span> phone<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> phone <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span></span>      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Current application code can be found on <a href=\"https://github.com/fullstack-hy2020/graphql-phonebook-frontend/tree/part8-7\">Github</a>, branch <i>part8-7</i>.</p>\n<h3>Updating cache, revisited</h3>\n<p>We have to <a href=\"/en/part8/react_and_graph_ql#updating-the-cache\">update</a> the cache of the Apollo client on creating new persons. We can update it using the mutation's <em>refetchQueries</em> option to define that the\n<em>ALL_PERSONS</em> query is done again. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">PersonForm</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> setError <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span> createPerson <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CREATE_PERSON</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    refetchQueries<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>  <span class=\"token punctuation\">{</span>query<span class=\"token operator\">:</span> <span class=\"token constant\">ALL_PERSONS</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></span>    <span class=\"token function-variable function\">onError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setError</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>graphQLErrors<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This approach is pretty good, the drawback being that the query is always rerun with any updates. </p>\n<p>It is possible to optimize the solution by handling updating the cache ourselves. This is done by defining a suitable <a href=\"https://www.apollographql.com/docs/react/v3.0-beta/api/react/hooks/#options\">update</a>-callback for the mutation, which Apollo runs after the mutation:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">PersonForm</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> setError <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span> createPerson <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CREATE_PERSON</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">onError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setError</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>graphQLErrors<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token function-variable function\">update</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">store<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> dataInStore <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">readQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> query<span class=\"token operator\">:</span> <span class=\"token constant\">ALL_PERSONS</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      store<span class=\"token punctuation\">.</span><span class=\"token function\">writeQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        query<span class=\"token operator\">:</span> <span class=\"token constant\">ALL_PERSONS</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">        data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token operator\">...</span>dataInStore<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">          allPersons<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">...</span>dataInStore<span class=\"token punctuation\">.</span>allPersons<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>addPerson <span class=\"token punctuation\">]</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n \n  <span class=\"token comment\">// ..</span>\n<span class=\"token punctuation\">}</span>  </code></pre></div>\n<p>The callback function is given a reference to the cache and the data returned by the mutation as parameters. For example, in our case this would be the created person. </p>\n<p>The code reads the cached state of <em>ALL_PERSONS</em> query using <a href=\"https://www.apollographql.com/docs/react/v3.0-beta/caching/cache-interaction/#readquery\">readQuery</a> function and updates the cache with <a href=\"https://www.apollographql.com/docs/react/v3.0-beta/caching/cache-interaction/#writequery-and-writefragment\">writeQuery</a> function adding the new person to the cached data. </p>\n<p>Note that readQuery will throw an error if your cache does not contain all of the data necessary to fulfill the specified query. This can be solved using a try-catch block.</p>\n<!-- On myös olemassa tilanteita, joissa ainoa järkevä tapa saada välimuisti pidettyä ajantasaisena on _update_-callbackillä tehtävä päivitys.  -->\n<p>In some situations the only sensible way to keep the cache up to date is using the <em>update</em>-callback.</p>\n<p>When necessary it is possible to disable cache for the whole application or <a href=\"https://www.apollographql.com/docs/react/api/react/hooks/#options\">single queries</a> by setting the field managing the use of cache, <a href=\"https://www.apollographql.com/docs/react/data/queries/#configuring-fetch-logic\">fetchPolicy</a> as <em>no-cache</em>.</p>\n<p>Be diligent with the cache. Old data in cache can cause hard to find bugs. As we know, keeping the cache up to date is very challenging. According to a coder proverb:</p>\n<blockquote>\n<p><i>There are only two hard things in Computer Science: cache invalidation and naming things.</i> Read more <a href=\"https://www.google.com/search?q=two+hard+things+in+Computer+Science&#x26;oq=two+hard+things+in+Computer+Science\">here</a>.</p>\n</blockquote>\n<p>The current code of the application can be found on <a href=\"https://github.com/fullstack-hy2020/graphql-phonebook-frontend/tree/part8-8\">Github</a>, branch <i>part8-8</i>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Exercises 8.17.-8.22.</h3>\n<h4>8.17 Listing books</h4>\n<p>After the backend changes the list of books does not work anymore. Fix it. </p>\n<h4>8.18 Log in</h4>\n<p>Adding new books and changing the birth year of an author do not work because they require user to be logged in. </p>\n<p>Implement login functionality and fix the mutations. </p>\n<p>It is not necessary yet to handle validation errors. </p>\n<p>You can decide how the log in looks on the user interface. One possible solution is to make the login form into a separate view which can be accessed through a navigation menu: </p>\n<picture><img src=\"/static/ae6440af26b9fab098dac489635df2d8/5a190/26.png\" srcset=\"/static/ae6440af26b9fab098dac489635df2d8/772e8/26.png 200w,\n/static/ae6440af26b9fab098dac489635df2d8/e17e5/26.png 400w,\n/static/ae6440af26b9fab098dac489635df2d8/5a190/26.png 800w,\n/static/ae6440af26b9fab098dac489635df2d8/c1b63/26.png 1200w,\n/static/ae6440af26b9fab098dac489635df2d8/29007/26.png 1600w,\n/static/ae6440af26b9fab098dac489635df2d8/c4842/26.png 1634w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>The login form:</p>\n<picture><img src=\"/static/b58de44d2b5381c18a235232acd2dee0/5a190/27.png\" srcset=\"/static/b58de44d2b5381c18a235232acd2dee0/772e8/27.png 200w,\n/static/b58de44d2b5381c18a235232acd2dee0/e17e5/27.png 400w,\n/static/b58de44d2b5381c18a235232acd2dee0/5a190/27.png 800w,\n/static/b58de44d2b5381c18a235232acd2dee0/c1b63/27.png 1200w,\n/static/b58de44d2b5381c18a235232acd2dee0/29007/27.png 1600w,\n/static/b58de44d2b5381c18a235232acd2dee0/81315/27.png 1656w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>When a user is logged in, the navigation changes to show the functionalities which can only be done by a logged in user:</p>\n<picture><img src=\"/static/5277ba8cd826fcd16cff384820343666/5a190/28.png\" srcset=\"/static/5277ba8cd826fcd16cff384820343666/772e8/28.png 200w,\n/static/5277ba8cd826fcd16cff384820343666/e17e5/28.png 400w,\n/static/5277ba8cd826fcd16cff384820343666/5a190/28.png 800w,\n/static/5277ba8cd826fcd16cff384820343666/c1b63/28.png 1200w,\n/static/5277ba8cd826fcd16cff384820343666/29007/28.png 1600w,\n/static/5277ba8cd826fcd16cff384820343666/1d499/28.png 1632w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>8.19 Books by genre, part 1</h4>\n<p>Complete your application to filter the book list by genre. Your solution might look something like this:</p>\n<picture><img src=\"/static/44fc6b0d6b88ef933fc2f26acec86a20/5a190/30.png\" srcset=\"/static/44fc6b0d6b88ef933fc2f26acec86a20/772e8/30.png 200w,\n/static/44fc6b0d6b88ef933fc2f26acec86a20/e17e5/30.png 400w,\n/static/44fc6b0d6b88ef933fc2f26acec86a20/5a190/30.png 800w,\n/static/44fc6b0d6b88ef933fc2f26acec86a20/c1b63/30.png 1200w,\n/static/44fc6b0d6b88ef933fc2f26acec86a20/29007/30.png 1600w,\n/static/44fc6b0d6b88ef933fc2f26acec86a20/6a5c3/30.png 1646w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>In this exercise the filtering can be done using just React.</p>\n<h4>8.20 Books by genre, part 2</h4>\n<p>Implement a view which shows all the books based on the logged in user's favourite genre.</p>\n<picture><img src=\"/static/136c0baca4e5a67ca4387cfa93b098e4/5a190/29.png\" srcset=\"/static/136c0baca4e5a67ca4387cfa93b098e4/772e8/29.png 200w,\n/static/136c0baca4e5a67ca4387cfa93b098e4/e17e5/29.png 400w,\n/static/136c0baca4e5a67ca4387cfa93b098e4/5a190/29.png 800w,\n/static/136c0baca4e5a67ca4387cfa93b098e4/c1b63/29.png 1200w,\n/static/136c0baca4e5a67ca4387cfa93b098e4/29007/29.png 1600w,\n/static/136c0baca4e5a67ca4387cfa93b098e4/5c263/29.png 1636w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>8.21 books by genre with GraphQL</h4>\n<p>In the previous exercise 8.20, the filtering could have been done using just React. To complete this exercise, you should filter the books in the recommendations page using a GraphQL query to the server. The query created in exercise 8.5 could be useful here. </p>\n<p>This and the next exercises are quite <strong>challenging</strong> like it should be this late in the course. You might want to complete first the easier ones in <a href=\"/en/part8/fragments_and_subscriptions\">next part</a>.</p>\n<p>Some tips</p>\n<ul>\n<li>Instead of using <i>useQuery</i> it is propably better to do the queries with the <i>useLazyQuery</i>-hook</li>\n<li>It is sometimes useful to save the results of a GraphQL query to the state of a component. </li>\n<li>Note, that you can do GraphQL queries in a <i>useEffect</i>-hook.</li>\n<li>The <a href=\"https://reactjs.org/docs/hooks-reference.html#conditionally-firing-an-effect\">second parameter</a> of a <i>useEffect</i> - hook can become handy depending on your approach. </li>\n</ul>\n<h4>8.22 Up to date cache and book recommendations</h4>\n<p>If you fetch the book recommendations with GraphQL, ensure somehow that the books view is kept up to date. So when a new book is added, the books view is updated <strong>at least</strong> when a genre selection button is pressed. </p>\n<p><i>When new genre selection is not done, the view does not have to be updated. </i></p>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/255b3daaf137d97fa5b78561e6ef4e3f/part-8.svg"},"part":8,"letter":"d","lang":"en"}}},"pageContext":{"part":8,"letter":"d","lang":"en"}}}